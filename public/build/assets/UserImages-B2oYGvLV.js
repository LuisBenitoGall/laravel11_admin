import{r as m,j as a,a as $}from"./app-DRj95fl3.js";import{u as se}from"./useTranslation-BmHTxgDU.js";import{u as ne}from"./useSweetAlert-D-bXTlQV.js";import{O as V,T as H}from"./OverlayTrigger-BXbmHDr2.js";function ie({existingImages:h=[],imagePath:d=null,uploadUrl:g,deleteUrl:l=null,setFeaturedUrl:u=!1,uploadParamName:E="file",maxFiles:_=20,maxFileSize:A=3*1024*1024,acceptedTypes:w=["image/jpeg","image/png","image/gif","image/webp"],onChange:x=()=>{},autoUpload:F=!0,showProgress:oe=!1,className:B="",entityId:k=null,entityParamName:q="entity_id"}){const f=se(),{showConfirm:G}=ne(),S=m.useRef(null),v=(e,t={})=>{try{if(typeof e=="string"&&typeof route=="function")try{return route(e,t)}catch{}}catch{}return e},[O,y]=m.useState(Array.isArray(h)?h.slice():[]),[z,N]=m.useState({}),[T,c]=m.useState(null),[D,W]=m.useState(!1),[I,K]=m.useState(null),[P,Q]=m.useState(""),J=O.length+Object.keys(z).length,C=e=>!e||typeof e!="string"?"":e.startsWith("http")||e.startsWith("/")||e.startsWith("data:")||e.includes("/")?e:`${d?`/storage/${d.replace(/\/$/,"")}/`:"/storage/"}${e}`,M=e=>{if(!e)return null;if(typeof e=="string")return{image:e,url:C(e),__key:`tmp_${e}_${Date.now()}`};const t={...e};return t.url||(t.path?t.url=t.path:t.preview?t.url=t.preview:t.file&&t.file.url?t.url=t.file.url:t.filename?t.url=C(t.filename):t.image&&(t.url=C(t.image))),t.__key||(t.__key=t.id?`id_${t.id}`:`tmp_${Math.random().toString(36).slice(2,8)}_${Date.now()}`),t};m.useEffect(()=>{if(!Array.isArray(h))return;const e=h.map(t=>M(t)).filter(Boolean);y(e)},[h,d]);const X=e=>!(!w.includes(e.type)||e.size>A),R=e=>{c(null);const t=Array.from(e||[]);if(J+t.length>_){c(`Máximo ${_} imágenes permitidas.`);return}const n=t.filter(r=>X(r));t.length-n.length&&c("Algunos archivos no válidos (tipo/tamaño)."),n.forEach(r=>Y(r))},Y=async e=>{const t=`tmp_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;if(N(n=>({...n,[t]:{progress:0,file:e}})),!F||!g){const n={__tmp:t,__key:`tmp_${t}`,name:e.name,url:URL.createObjectURL(e),file:e};y(s=>{const r=s.concat(n);return x(r),r}),N(s=>{const r={...s};return delete r[t],r});return}try{const n=new FormData;n.append(E,e),k!=null&&n.append(q,k);const s=v(g,k||{}),r=await $.post(s,n,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:o=>{const j=o.total?Math.round(o.loaded*100/o.total):0;N(b=>({...b,[t]:{progress:j,file:e}}))}});let i=[];if(!r||!r.data)i=[];else if(Array.isArray(r.data))i=r.data;else if(Array.isArray(r.data.images))i=r.data.images;else if(r.data.image)i=Array.isArray(r.data.image)?r.data.image:[r.data.image];else if(r.data.data&&Array.isArray(r.data.data))i=r.data.data;else{const o=r.data;o&&(o.id||o.url)&&(i=[o])}y(o=>{const j=i.map(p=>M(p)).filter(Boolean),b=o.concat(j);return x(b),b})}catch(n){console.error("Upload error",n),c("Error subiendo archivo")}finally{N(n=>{const s={...n};return delete s[t],s})}},Z=async e=>{G({title:f("imagen_eliminar")??"Eliminar imagen",text:f("imagen_eliminar_confirm")??"¿Quieres eliminar esta imagen?",icon:"warning",onConfirm:async()=>{var n;if(e.__tmp){y(s=>{const r=s.filter(i=>i.__tmp!==e.__tmp);return x(r),r});return}if(!l){y(s=>{const r=s.filter(i=>i.id!==e.id);return x(r),r});return}let t=null;if(typeof l=="function")try{t=l(e)}catch(s){console.error("Error resolviendo deleteUrl function",s),c("No se pudo resolver la ruta de borrado. Comprueba que la imagen tiene id.");return}else if(typeof l=="string")if(l.includes(":id"))t=l.replace(":id",e.id);else{let s=v(l,[e.id]);(!s||s===l)&&(s=v(l,e.id)),s&&typeof s=="string"&&s!==l?t=s:t=`${l.replace(/\/$/,"")}/${e.id}`}try{if(!t)try{const s=v(l,[e.id]);s&&typeof s=="string"&&s!==l&&(t=s)}catch{}if(!t){console.error("Could not resolve deleteUrl for image",{deleteUrl:l,img:e}),c("Url de borrado inválida");return}await $.delete(t,{data:{}}),y(s=>{const r=s.filter(i=>e.id?i.id!==e.id:i.image&&i.image!==e.image&&i.url&&i.url!==e.url&&i.__key&&i.__key!==e.__key);return x(r),r})}catch(s){console.error("Delete error",s);const r=(n=s==null?void 0:s.response)==null?void 0:n.status;if(r===405||r===404)try{const i=new FormData;i.append("_method","DELETE");const o=await $.post(t,i,{headers:{"Content-Type":"multipart/form-data"}});if(o&&(o.status===200||o.status===204||o.status===202)){y(j=>{const b=j.filter(p=>e.id?p.id!==e.id:p.image&&p.image!==e.image&&p.url&&p.url!==e.url&&p.__key&&p.__key!==e.__key);return x(b),b});return}}catch(i){console.error("Fallback delete error",i)}c("Error borrando imagen")}}})},U=async e=>{if(!u)return;let t=null;if(typeof u=="function")try{t=u(e)}catch(n){console.error("Error resolviendo setFeaturedUrl function",n),c("No se pudo resolver la ruta para establecer como principal");return}else if(typeof u=="string")try{t=v(u,{image:e.id??e.image})}catch{t=u}if(!t){c("Url para marcar como principal inválida");return}try{const n=e.id?{id:e.id}:{image:e.image},s=await $.post(t,n);y(r=>{const i=r.map(o=>e.id&&o.id===e.id?{...o,featured:!0}:!e.id&&o.image&&e.image&&o.image===e.image?{...o,featured:!0}:{...o,featured:!1});return x(i),i})}catch(n){console.error("Set featured error",n),c("Error marcando imagen principal")}};m.useEffect(()=>{const e=t=>{t.key==="Escape"&&D&&W(!1)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[D]);const ee=(e,t="")=>{K(e),Q(t),W(!0)},L=()=>W(!1),te=e=>{e.preventDefault(),e.stopPropagation();const t=e.dataTransfer;t&&t.files&&R(t.files)},re=e=>{e.preventDefault()},ae=()=>S.current&&S.current.click();return a.jsxs("div",{className:`dropzone-gallery ${B}`,children:[a.jsxs("div",{className:"p-3 mb-3 border rounded text-center",style:{borderStyle:"dashed",cursor:"pointer"},onDrop:te,onDragOver:re,onClick:ae,children:[a.jsx("input",{ref:S,type:"file",multiple:!0,accept:w.map(e=>e).join(","),style:{display:"none"},onChange:e=>R(e.target.files)}),a.jsxs("div",{className:"mb-2 pt-3",children:[a.jsx("strong",{children:f("imagenes_anadir")}),a.jsx("br",{}),a.jsx("i",{className:"la la-image fs-1 my-4"})]}),a.jsxs("div",{className:"small text-muted pb-4",children:[f("imagenes_arrastrar_click")," (máx ",_," archivos)"]})]}),T&&a.jsx("div",{className:"alert alert-danger small mx-0 mb-3",children:T}),a.jsxs("div",{className:"row g-2",children:[O.map(e=>{let t=null;if(e.url)t=e.url;else if(e.path)t=e.path;else if(e.preview)t=e.preview;else if(e.file&&e.file.url)t=e.file.url;else if(e.filename)t=e.filename;else if(e.image){const n=e.image;typeof n=="string"&&(n.startsWith("http")||n.startsWith("/")||n.startsWith("data:")||n.includes("/"))?t=n:d?t=`/storage/${d.replace(/\/$/,"")}/${n}`:t=n}return t=t||"",t&&typeof t=="string"&&!t.startsWith("http")&&!t.startsWith("/")&&!t.startsWith("data:")&&!t.includes("/")&&(t=`${d?`/storage/${d.replace(/\/$/,"")}/`:"/storage/"}${t}`),a.jsx("div",{className:"col-6 col-sm-4 col-md-3",children:a.jsxs("div",{className:"position-relative border rounded overflow-hidden",style:{minHeight:80},children:[a.jsx("img",{src:t,alt:e.name??"",style:{width:"100%",height:120,objectFit:"cover",cursor:"pointer"},onClick:()=>ee(t,e.name??"")}),a.jsxs("div",{style:{position:"absolute",top:6,right:6,display:"flex",flexDirection:"column",gap:6},children:[a.jsx(V,{placement:"left",overlay:a.jsx(H,{id:`tooltip-delete-${e.__key??e.id}`,children:f("imagen_eliminar")??"Eliminar imagen"}),children:a.jsx("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>Z(e),children:a.jsx("i",{className:"la la-trash"})})}),u&&a.jsx(V,{placement:"left",overlay:a.jsx(H,{id:`tooltip-featured-${e.__key??e.id}`,children:e.featured?f("imagen_destacada")??"Principal":f("imagen_destacada_marcar")??"Marcar principal"}),children:a.jsx("button",{type:"button",className:`btn btn-sm ${e.featured?"btn-warning":"btn-light"}`,onClick:()=>U(e),children:a.jsx("i",{className:"la la-star",style:{color:e.featured?"#fff":"#333"}})})})]})]})},e.id??e.__tmp??e.url??e.image)}),Object.keys(z).map(e=>a.jsx("div",{className:"col-6 col-sm-4 col-md-3",children:a.jsx("div",{className:"position-relative border rounded d-flex align-items-center justify-content-center",style:{minHeight:120},children:a.jsxs("div",{className:"text-center small",children:[a.jsx("div",{className:"spinner-border spinner-border-sm",role:"status",children:a.jsx("span",{className:"visually-hidden",children:f("cargando")})}),a.jsx("div",{className:"mt-2",children:f("subiendo")})]})})},e))]}),D&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"modal-backdrop fade show",style:{position:"fixed",inset:0,backgroundColor:"rgba(0,0,0,0.6)",zIndex:1050},onClick:L}),a.jsx("div",{className:"image-viewer-overlay d-flex align-items-center justify-content-center",style:{position:"fixed",inset:0,zIndex:1060,pointerEvents:"none"},children:a.jsxs("div",{style:{pointerEvents:"auto",maxWidth:"95%",maxHeight:"95%",position:"relative"},children:[a.jsx("button",{type:"button",className:"btn btn-sm btn-light position-absolute",style:{top:-12,right:-12,zIndex:1070},onClick:L,children:a.jsx("i",{className:"la la-close"})}),a.jsx("img",{src:I,alt:P,style:{display:"block",maxWidth:"100%",maxHeight:"80vh",borderRadius:6}})]})})]})]})}function fe({images:h=[],uploadUrl:d=null,deleteUrl:g=null,onChange:l=()=>{},entityId:u=null,imagePath:E=null,setFeaturedUrl:_=!1}){const A=w=>{typeof l=="function"&&l(w)};return a.jsx("div",{className:"col-12 gy-2",children:a.jsx(ie,{existingImages:h,imagePath:E,uploadUrl:d,setFeaturedUrl:_,deleteUrl:g,entityId:u,uploadParamName:"file",maxFiles:20,maxFileSize:3*1024*1024,acceptedTypes:["image/jpeg","image/png","image/gif","image/webp"],onChange:A,autoUpload:!0})})}export{fe as default};
