import{r as c,j as a,a as $}from"./app-NnFxdXA2.js";import{u as Z}from"./useTranslation-D4BTlT_h.js";import{u as U}from"./useSweetAlert-9_SeR-8m.js";function ee({existingImages:x=[],imagePath:d=null,uploadUrl:g,deleteUrl:o=null,uploadParamName:_="file",maxFiles:y=20,maxFileSize:E=3*1024*1024,acceptedTypes:v=["image/jpeg","image/png","image/gif","image/webp"],onChange:u=()=>{},autoUpload:F=!0,showProgress:te=!1,className:L="",entityId:b=null,entityParamName:R="entity_id"}){const p=Z(),{showConfirm:T}=U(),k=c.useRef(null),j=(e,t={})=>{try{if(typeof e=="string"&&typeof route=="function")try{return route(e,t)}catch{}}catch{}return e},[S,f]=c.useState(Array.isArray(x)?x.slice():[]),[z,w]=c.useState({}),[C,m]=c.useState(null),[D,A]=c.useState(!1),[G,M]=c.useState(null),[V,H]=c.useState(""),I=S.length+Object.keys(z).length,P=e=>!(!v.includes(e.type)||e.size>E),O=e=>{m(null);const t=Array.from(e||[]);if(I+t.length>y){m(`Máximo ${y} imágenes permitidas.`);return}const n=t.filter(s=>P(s));t.length-n.length&&m("Algunos archivos no válidos (tipo/tamaño)."),n.forEach(s=>K(s))},K=async e=>{const t=`tmp_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;if(w(n=>({...n,[t]:{progress:0,file:e}})),!F||!g){const n={__tmp:t,name:e.name,url:URL.createObjectURL(e),file:e};f(r=>{const s=r.concat(n);return u(s),s}),w(r=>{const s={...r};return delete s[t],s});return}try{const n=new FormData;n.append(_,e),b!=null&&n.append(R,b);const r=j(g,b||{}),s=await $.post(r,n,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:l=>{const h=l.total?Math.round(l.loaded*100/l.total):0;w(N=>({...N,[t]:{progress:h,file:e}}))}});let i=[];if(!s||!s.data)i=[];else if(Array.isArray(s.data))i=s.data;else if(Array.isArray(s.data.images))i=s.data.images;else if(s.data.image)i=Array.isArray(s.data.image)?s.data.image:[s.data.image];else if(s.data.data&&Array.isArray(s.data.data))i=s.data.data;else{const l=s.data;l&&(l.id||l.url)&&(i=[l])}f(l=>{const h=l.concat(i);return u(h),h})}catch(n){console.error("Upload error",n),m("Error subiendo archivo")}finally{w(n=>{const r={...n};return delete r[t],r})}},Q=async e=>{T({title:p("imagen_eliminar")??"Eliminar imagen",text:p("imagen_eliminar_confirm")??"¿Quieres eliminar esta imagen?",icon:"warning",onConfirm:async()=>{var n;if(e.__tmp){f(r=>{const s=r.filter(i=>i.__tmp!==e.__tmp);return u(s),s});return}if(!o){f(r=>{const s=r.filter(i=>i.id!==e.id);return u(s),s});return}console.debug("DropzoneGallery handleDelete deleteUrl:",o),console.debug("DropzoneGallery handleDelete img object:",e);let t=null;if(typeof o=="function")t=o(e);else if(typeof o=="string")if(o.includes(":id"))t=o.replace(":id",e.id);else{let r=j(o,[e.id]);(!r||r===o)&&(r=j(o,e.id)),r&&typeof r=="string"&&r!==o?t=r:t=`${o.replace(/\/$/,"")}/${e.id}`}try{if(!t)try{const r=j(o,[e.id]);r&&typeof r=="string"&&r!==o&&(t=r)}catch{}if(!t){console.error("Could not resolve deleteUrl for image",{deleteUrl:o,img:e}),m("Url de borrado inválida");return}console.debug("DropzoneGallery deleting URL:",t),await $.delete(t,{data:{}}),f(r=>{const s=r.filter(i=>i.id!==e.id);return u(s),s})}catch(r){console.error("Delete error",r);const s=(n=r==null?void 0:r.response)==null?void 0:n.status;if(s===405||s===404)try{console.debug("DropzoneGallery attempting fallback POST _method=DELETE to",t);const i=new FormData;i.append("_method","DELETE");const l=await $.post(t,i,{headers:{"Content-Type":"multipart/form-data"}});if(l&&(l.status===200||l.status===204||l.status===202)){f(h=>{const N=h.filter(Y=>Y.id!==e.id);return u(N),N});return}}catch(i){console.error("Fallback delete error",i)}m("Error borrando imagen")}}})};c.useEffect(()=>{const e=t=>{t.key==="Escape"&&D&&A(!1)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[D]);const q=(e,t="")=>{M(e),H(t),A(!0)},W=()=>A(!1),B=e=>{e.preventDefault(),e.stopPropagation();const t=e.dataTransfer;t&&t.files&&O(t.files)},J=e=>{e.preventDefault()},X=()=>k.current&&k.current.click();return a.jsxs("div",{className:`dropzone-gallery ${L}`,children:[a.jsxs("div",{className:"p-3 mb-3 border rounded text-center",style:{borderStyle:"dashed",cursor:"pointer"},onDrop:B,onDragOver:J,onClick:X,children:[a.jsx("input",{ref:k,type:"file",multiple:!0,accept:v.map(e=>e).join(","),style:{display:"none"},onChange:e=>O(e.target.files)}),a.jsxs("div",{className:"mb-2 pt-3",children:[a.jsx("strong",{children:p("imagenes_anadir")}),a.jsx("br",{}),a.jsx("i",{className:"la la-image fs-1 my-4"})]}),a.jsxs("div",{className:"small text-muted pb-4",children:[p("imagenes_arrastrar_click")," (máx ",y," archivos)"]})]}),C&&a.jsx("div",{className:"alert alert-danger small mx-0 mb-3",children:C}),a.jsxs("div",{className:"row g-2",children:[S.map(e=>{let t=null;if(e.url)t=e.url;else if(e.path)t=e.path;else if(e.preview)t=e.preview;else if(e.file&&e.file.url)t=e.file.url;else if(e.filename)t=e.filename;else if(e.image){const n=e.image;typeof n=="string"&&(n.startsWith("http")||n.startsWith("/")||n.startsWith("data:")||n.includes("/"))?t=n:d?t=`/storage/${d.replace(/\/$/,"")}/${n}`:t=n}return t=t||"",t&&typeof t=="string"&&!t.startsWith("http")&&!t.startsWith("/")&&!t.startsWith("data:")&&!t.includes("/")&&(t=`${d?`/storage/${d.replace(/\/$/,"")}/`:"/storage/"}${t}`),a.jsx("div",{className:"col-6 col-sm-4 col-md-3",children:a.jsxs("div",{className:"position-relative border rounded overflow-hidden",style:{minHeight:80},children:[a.jsx("img",{src:t,alt:e.name??"",style:{width:"100%",height:120,objectFit:"cover",cursor:"pointer"},onClick:()=>q(t,e.name??"")}),a.jsx("button",{type:"button",className:"btn btn-sm btn-danger position-absolute",style:{top:6,right:6},onClick:()=>Q(e),children:a.jsx("i",{className:"la la-trash"})})]})},e.id??e.__tmp??e.url??e.image)}),Object.keys(z).map(e=>a.jsx("div",{className:"col-6 col-sm-4 col-md-3",children:a.jsx("div",{className:"position-relative border rounded d-flex align-items-center justify-content-center",style:{minHeight:120},children:a.jsxs("div",{className:"text-center small",children:[a.jsx("div",{className:"spinner-border spinner-border-sm",role:"status",children:a.jsx("span",{className:"visually-hidden",children:p("cargando")})}),a.jsx("div",{className:"mt-2",children:p("subiendo")})]})})},e))]}),D&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"modal-backdrop fade show",style:{position:"fixed",inset:0,backgroundColor:"rgba(0,0,0,0.6)",zIndex:1050},onClick:W}),a.jsx("div",{className:"image-viewer-overlay d-flex align-items-center justify-content-center",style:{position:"fixed",inset:0,zIndex:1060,pointerEvents:"none"},children:a.jsxs("div",{style:{pointerEvents:"auto",maxWidth:"95%",maxHeight:"95%",position:"relative"},children:[a.jsx("button",{type:"button",className:"btn btn-sm btn-light position-absolute",style:{top:-12,right:-12,zIndex:1070},onClick:W,children:a.jsx("i",{className:"la la-close"})}),a.jsx("img",{src:G,alt:V,style:{display:"block",maxWidth:"100%",maxHeight:"80vh",borderRadius:6}})]})})]})]})}function ne({images:x=[],uploadUrl:d=null,deleteUrl:g=null,onChange:o=()=>{},entityId:_=null,imagePath:y=null}){const E=v=>{typeof o=="function"&&o(v)};return a.jsx("div",{className:"col-12 gy-2",children:a.jsx(ee,{existingImages:x,imagePath:y,uploadUrl:d,deleteUrl:g,entityId:_,uploadParamName:"file",maxFiles:20,maxFileSize:3*1024*1024,acceptedTypes:["image/jpeg","image/png","image/gif","image/webp"],onChange:E,autoUpload:!0})})}export{ne as default};
